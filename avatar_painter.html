<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatar Mask Painter</title>
    <style>
      :root {
        --bg-color: #e0e0e0;
        --sidebar-width: 300px;
        /* Avatar Colors */
        --skin-color: #ffcc99;
        --shirt-color: #3498db;
        --pants-color: #2c3e50;
        --hair-color: #3e2723;
        --mask-color: #333;
        --shoes-color: #1a1a1a;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        overflow: hidden;
        font-family: "Segoe UI", sans-serif;
        display: flex;
        height: 100vh;
        background-color: #ccc;
      }

      /* SIDEBAR */
      #sidebar {
        width: var(--sidebar-width);
        background: #fff;
        padding: 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
      }

      h3 {
        margin: 0 0 5px 0;
        color: #333;
        border-bottom: 2px solid #ddd;
        padding-bottom: 5px;
      }
      .section-title {
        font-size: 12px;
        font-weight: bold;
        color: #888;
        text-transform: uppercase;
        margin-top: 10px;
      }

      label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight: 600;
        color: #555;
      }
      input[type="color"] {
        border: none;
        width: 30px;
        height: 30px;
        cursor: pointer;
      }
      select,
      input[type="range"] {
        width: 60%;
      }
      button {
        padding: 10px;
        cursor: pointer;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        margin-top: 5px;
      }

      /* CANVAS AREA */
      #canvasContainer {
        flex-grow: 1;
        position: relative;
        cursor: crosshair;
        background: #ffffff;
        background-image: radial-gradient(#ddd 1px, transparent 1px);
        background-size: 20px 20px;
        overflow: hidden;
      }

      canvas {
        display: block;
        width: 100%;
        height: 100%;
      }

      /* --- AVATAR WRAPPER (Follows Mouse) --- */
      #avatarWrapper {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none; /* Allows clicking THROUGH avatar */
        transform-style: preserve-3d;
        z-index: 100;
        transition: transform 0.05s linear;
      }

      /* Scale down the Robust Avatar for the tool */
      #pivot {
        position: relative;
        transform-style: preserve-3d;
        transform: scale(0.35) rotateX(-20deg) rotateY(25deg);
      }

      /* --- ROBUST CUBOID ENGINE (From avatar.html) --- */
      .cuboid {
        position: absolute;
        transform-style: preserve-3d;
      }
      
      .face {
        position: absolute;
        backface-visibility: hidden;
        outline: 1px solid rgba(0,0,0,0.03); 
      }

      /* Standard mapping based on CSS Vars --w, --h, --d */
      .cuboid .front  { width: var(--w); height: var(--h); transform: translateZ(calc(var(--d) / 2)); }
      .cuboid .back   { width: var(--w); height: var(--h); transform: rotateY(180deg) translateZ(calc(var(--d) / 2)); }
      .cuboid .right  { 
        width: var(--d); height: var(--h); 
        left: calc((var(--w) - var(--d)) / 2); 
        transform: rotateY(90deg) translateZ(calc(var(--w) / 2)); 
      }
      .cuboid .left   { 
        width: var(--d); height: var(--h); 
        left: calc((var(--w) - var(--d)) / 2); 
        transform: rotateY(-90deg) translateZ(calc(var(--w) / 2)); 
      }
      .cuboid .top    { 
        width: var(--w); height: var(--d); 
        top: calc((var(--h) - var(--d)) / 2); 
        transform: rotateX(90deg) translateZ(calc(var(--h) / 2)); 
      }
      .cuboid .bottom { 
        width: var(--w); height: var(--d); 
        top: calc((var(--h) - var(--d)) / 2); 
        transform: rotateX(-90deg) translateZ(calc(var(--h) / 2)); 
      }

      /* Lighting */
      .front { filter: brightness(1.0); }
      .back { filter: brightness(0.6); }
      .right, .left { filter: brightness(0.75); }
      .top { filter: brightness(1.15); }
      .bottom { filter: brightness(0.4); }

      /* --- AVATAR PARTS --- */
      
      /* BODY */
      .body {
        --w: 60px; --h: 70px; --d: 30px;
        transform: translate3d(-30px, -70px, 0); 
      }
      .body .face { background: var(--shirt-color); }
      .body .top { background: var(--skin-color); } 

      /* NECK */
      .neck {
        --w: 20px; --h: 10px; --d: 20px;
        transform: translate3d(-10px, -80px, 0);
      }
      .neck .face { background: var(--skin-color); filter: brightness(0.85); }

      /* HEAD */
      .head {
        --w: 60px; --h: 60px; --d: 60px;
        transform: translate3d(-30px, -140px, 0);
      }
      .head .face { background: var(--skin-color); }
      
      /* Face Details */
      .eye { position: absolute; width: 10px; height: 10px; background: #222; top: 25px; border-radius: 50%; }
      .eye.l { left: 12px; }
      .eye.r { right: 12px; }
      /* Mouth removed in favor of brush concentration, or keep small line */
      .mouth { position: absolute; width: 24px; height: 6px; background: #a55; top: 45px; left: 18px; border-radius: 4px; }

      /* HAIR */
      .hair {
        --w: 64px; --h: 20px; --d: 64px;
        transform: translate3d(-32px, -150px, 0);
      }
      .hair .face { background: var(--hair-color); }
      .hair-back {
        --w: 64px; --h: 30px; --d: 64px;
        transform: translate3d(-32px, -135px, 0);
      }
      .hair-back .face { background: var(--hair-color); }
      .hair-back .front, .hair-back .bottom { display: none; } 

      /* ARMS */
      .arm {
        --w: 20px; --h: 70px; --d: 20px;
        transform-origin: 50% 10px; 
      }
      .arm .face { background: var(--skin-color); }
      .arm .top, .arm .top + div { background: var(--shirt-color); } 
      .arm .top { background: var(--shirt-color); }

      .arm.left { transform: translate3d(-50px, -65px, 0); }
      .arm.right { transform: translate3d(30px, -65px, 0); }

      /* LEGS */
      .leg {
        --w: 24px; --h: 70px; --d: 24px;
        transform-origin: 50% 0; 
      }
      .leg .face { background: var(--pants-color); }
      .leg .bottom { background: var(--shoes-color); }

      .leg.left { transform: translate3d(-28px, 0, 0); }
      .leg.right { transform: translate3d(4px, 0, 0); }


      /* --- PAINTER SPECIFIC MODS --- */

      /* BRUSH (Attached to Right Arm) */
      .brush {
        position: absolute;
        width: 12px;
        height: 80px;
        background: #8e44ad;
        /* Position at hand: bottom of arm (y=70), center of arm width (10), shifted forward */
        transform: translate3d(4px, 60px, -20px) rotateX(90deg);
        transform-origin: 50% 0;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      }
      /* Tip of brush */
      .brush::after {
        content: "";
        position: absolute;
        bottom: 0; left: 0;
        width: 100%; height: 20px;
        background: inherit;
        filter: brightness(1.5); /* lighter tip */
      }

      /* MASK STYLES (Adapted for 3D Head) */
      .mask-ninja .head .face.front::after {
        content: "";
        position: absolute;
        bottom: 0; left: 0;
        width: 100%; height: 50%;
        background: var(--mask-color);
        z-index: 2;
      }
      .mask-hero .head .face.front::before {
        content: "";
        position: absolute;
        top: 15px; left: 0;
        width: 100%; height: 20px;
        background: var(--mask-color);
        z-index: 2;
      }

      /* ANIMATIONS */
      .walking .leg.left { animation: walk 0.4s infinite alternate; }
      .walking .leg.right { animation: walk 0.4s infinite alternate-reverse; }
      .walking .arm.left { animation: swing 0.4s infinite alternate; }
      
      /* Right arm holds the brush steady-ish while walking */
      .walking .arm.right {
        /* Lift arm up to paint */
        transform: translate3d(30px, -65px, 0) rotateX(-90deg);
        animation: paint-bob 0.2s infinite alternate;
      }

      .walking .body, .walking .head, .walking .hair, .walking .neck, .walking .hair-back {
        animation: bounce 0.2s infinite alternate;
      }

      @keyframes walk {
        from { transform: translate3d(var(--tx, -28px), 0, 0) rotateX(25deg); }
        to { transform: translate3d(var(--tx, -28px), 0, 0) rotateX(-25deg); }
      }
      .leg.left { --tx: -28px; }
      .leg.right { --tx: 4px; }

      @keyframes swing {
        from { transform: translate3d(-50px, -65px, 0) rotateX(-25deg); }
        to { transform: translate3d(-50px, -65px, 0) rotateX(25deg); }
      }

      @keyframes paint-bob {
        from { transform: translate3d(30px, -65px, 0) rotateX(-85deg); }
        to { transform: translate3d(30px, -65px, 0) rotateX(-95deg); }
      }

      @keyframes bounce {
        from { transform: translate3d(var(--bx, 0), var(--by, 0), 0); }
        to { transform: translate3d(var(--bx, 0), calc(var(--by, 0) - 2px), 0); }
      }
      
      .body { --bx: -30px; --by: -70px; }
      .neck { --bx: -10px; --by: -80px; }
      .head { --bx: -30px; --by: -140px; }
      .hair { --bx: -32px; --by: -150px; }
      .hair-back { --bx: -32px; --by: -135px; }

    </style>
  </head>
  <body>
    <div id="sidebar">
      <h3>Disguise Painter</h3>

      <div class="section-title">Brush Settings</div>
      <label>Color: <input type="color" id="brushColor" value="#ff0000" /></label>
      <label>Size: <input type="range" id="brushSize" min="5" max="50" value="10" /></label>
      <label>Shape:
        <select id="brushShape">
          <option value="round">Circle</option>
          <option value="square">Square</option>
        </select>
      </label>

      <div class="section-title">Avatar Disguise</div>
      <label>Mask Type:
        <select id="maskSelect">
          <option value="none">None</option>
          <option value="mask-ninja">Ninja</option>
          <option value="mask-hero">Hero</option>
        </select>
      </label>
      <label>Mask/Suit: <input type="color" id="maskColorInp" value="#333333" /></label>
      <label>Skin: <input type="color" id="skinColor" value="#ffcc99" /></label>
      <label>Shirt: <input type="color" id="shirtColor" value="#3498db" /></label>
      <label>Hair: <input type="color" id="hairColor" value="#3e2723" /></label>

      <button onclick="clearCanvas()" style="background: #ffcccc; color: #c0392b">Clear Canvas</button>
      <button onclick="downloadCanvas()" style="background: #ccffcc; color: #27ae60">Download Art</button>

      <p style="font-size: 11px; color: #777; margin-top: 20px">
        The Avatar follows your mouse. Click and drag to paint!
      </p>
    </div>

    <div id="canvasContainer">
      <div id="avatarWrapper">
        <div id="pivot">
          
          <div class="cuboid leg left">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>
          <div class="cuboid leg right">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>

          <div class="cuboid body">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>

          <div class="cuboid neck">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>

          <div class="cuboid head">
            <div class="face front">
              <div class="eye l"></div><div class="eye r"></div>
            </div>
            <div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>

          <div class="cuboid hair">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>
          <div class="cuboid hair-back">
            <div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div>
          </div>

          <div class="cuboid arm left">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
          </div>
          <div class="cuboid arm right">
            <div class="face front"></div><div class="face back"></div>
            <div class="face left"></div><div class="face right"></div>
            <div class="face top"></div><div class="face bottom"></div>
            <div class="brush"></div>
          </div>

        </div>
      </div>

      <canvas id="maskCanvas"></canvas>
    </div>

    <script>
      // --- 1. SETUP CANVAS ---
      const canvas = document.getElementById("maskCanvas");
      const ctx = canvas.getContext("2d");
      const container = document.getElementById("canvasContainer");

      function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
      }
      window.addEventListener("resize", resize);
      resize();

      // --- 2. SETUP AVATAR & MOUSE TRACKING ---
      const avatarWrapper = document.getElementById("avatarWrapper");
      const pivot = document.getElementById("pivot");

      let isDrawing = false;

      container.addEventListener("mousemove", (e) => {
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // Move Avatar (Offset slightly so brush tip hits mouse)
        // With scale(0.35), the math changes slightly, but this is a good estimate
        avatarWrapper.style.transform = `translate(${x - 10}px, ${y - 40}px)`;

        if (isDrawing) draw(x, y);
      });

      container.addEventListener("mousedown", (e) => {
        isDrawing = true;
        pivot.classList.add("walking"); 

        const rect = container.getBoundingClientRect();
        draw(e.clientX - rect.left, e.clientY - rect.top);
      });

      window.addEventListener("mouseup", () => {
        isDrawing = false;
        pivot.classList.remove("walking"); 
        ctx.beginPath(); 
      });

      // --- 3. DRAWING LOGIC ---
      const brushColor = document.getElementById("brushColor");
      const brushSize = document.getElementById("brushSize");
      const brushShape = document.getElementById("brushShape");

      function draw(x, y) {
        ctx.lineWidth = brushSize.value;
        ctx.lineCap = brushShape.value === "round" ? "round" : "butt";
        ctx.strokeStyle = brushColor.value;
        ctx.fillStyle = brushColor.value;

        if (brushShape.value === "square") {
          const s = brushSize.value;
          ctx.fillRect(x - s / 2, y - s / 2, s, s);
        } else {
          ctx.lineTo(x, y);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(x, y);
        }
      }

      // --- 4. AVATAR CUSTOMIZATION ---
      const root = document.documentElement;

      document.getElementById("skinColor").addEventListener("input", (e) =>
          root.style.setProperty("--skin-color", e.target.value));
      document.getElementById("shirtColor").addEventListener("input", (e) =>
          root.style.setProperty("--shirt-color", e.target.value));
      document.getElementById("hairColor").addEventListener("input", (e) =>
          root.style.setProperty("--hair-color", e.target.value));
      document.getElementById("maskColorInp").addEventListener("input", (e) =>
          root.style.setProperty("--mask-color", e.target.value));

      // Mask Toggle
      // We apply class to #pivot or .head, but mostly it affects .head .face
      const avatarContainer = document.getElementById("pivot");
      document.getElementById("maskSelect").addEventListener("change", (e) => {
        // Remove existing mask classes
        avatarContainer.classList.remove("mask-ninja", "mask-hero");
        if(e.target.value !== "none") {
          avatarContainer.classList.add(e.target.value);
        }
      });

      // Brush Visual Update
      const brushVisual = document.querySelector(".brush");
      brushColor.addEventListener("input", (e) => {
        brushVisual.style.background = e.target.value;
      });

      // --- 5. BUTTONS ---
      window.clearCanvas = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      };

      window.downloadCanvas = () => {
        const link = document.createElement("a");
        link.download = "my-disguise-art.png";
        link.href = canvas.toDataURL();
        link.click();
      };
    </script>
  </body>
</html>