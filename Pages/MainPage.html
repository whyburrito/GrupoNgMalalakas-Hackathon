<!doctype html>
<html>
  <head>
    <title>WhiteMask V22 | Expressions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
      body {
        margin: 0;
        background: #0f172a;
        font-family: "Inter", sans-serif;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #sidebar {
        width: 320px;
        background: #f8fafc;
        padding: 25px;
        border-right: 1px solid #cbd5e1;
        display: flex;
        flex-direction: column;
        gap: 12px;
        z-index: 10;
        overflow-y: auto;
      }
      .canvas-area {
        position: relative;
        width: 270px;
        height: 340px;
        border: 2px solid #94a3b8;
        border-radius: 15px;
        overflow: hidden;
        background: #cbd5e1;
      }
      canvas#paintCanvas {
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }
      #viewer {
        flex: 1;
        cursor: grab;
        background: #111827;
      }

      #vibeContainer {
        background: #1e293b;
        color: white;
        padding: 15px;
        border-radius: 12px;
        margin-top: 10px;
      }
      #vibeText {
        font-weight: bold;
        color: #38bdf8;
        font-size: 1rem;
        text-transform: uppercase;
      }
      .bar-bg {
        height: 6px;
        background: #334155;
        border-radius: 3px;
        margin-top: 8px;
      }
      #vibeBar {
        height: 100%;
        width: 0%;
        background: #38bdf8;
        border-radius: 3px;
        transition: 0.6s;
      }

      .control-label {
        font-size: 0.7rem;
        font-weight: bold;
        color: #64748b;
        text-transform: uppercase;
        margin-top: 5px;
      }
      .btn-group {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 5px;
      }
      .btn {
        padding: 10px 5px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        background: white;
        font-size: 0.75rem;
      }
      .btn-active {
        background: #0f172a !important;
        color: white !important;
        border-color: #0f172a;
      }
      .btn-reset {
        background: #ef4444;
        color: white;
        border: none;
        padding: 12px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div id="sidebar">
      <h2 style="margin: 0; font-size: 1.1rem">WHITEMASK V22</h2>

      <div class="canvas-area">
        <canvas id="paintCanvas" width="512" height="640"></canvas>
      </div>

      <div class="control-label">Mask Expression</div>
      <div class="btn-group">
        <button
          id="mode-neutral"
          class="btn btn-active"
          onclick="setExpression('neutral')"
        >
          Neutral
        </button>
        <button id="mode-happy" class="btn" onclick="setExpression('happy')">
          Happy
        </button>
        <button id="mode-sad" class="btn" onclick="setExpression('sad')">
          Sad
        </button>
      </div>

      <div class="control-label">Brush Color</div>
      <input
        type="color"
        id="colorPicker"
        value="#ef4444"
        style="
          width: 100%;
          height: 35px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
        "
      />

      <div id="vibeContainer">
        <div style="font-size: 0.65rem; color: #94a3b8; margin-bottom: 4px">
          VIBE ANALYSIS:
        </div>
        <div id="vibeText">NEUTRAL</div>
        <div class="bar-bg"><div id="vibeBar"></div></div>
      </div>

      <button class="btn btn-reset" onclick="resetFace()">Reset Canvas</button>
    </div>
    <div id="viewer"></div>

    <script>
      const canvas = document.getElementById("paintCanvas");
      const ctx = canvas.getContext("2d");
      let isDrawing = false;
      let currentExpression = "neutral";

      function setExpression(mode) {
        currentExpression = mode;
        ["neutral", "happy", "sad"].forEach((m) => {
          document.getElementById(`mode-${m}`).className =
            m === mode ? "btn btn-active" : "btn";
        });
        resetFace();
      }

      function updateTexture() {
        if (mat) {
          mat.map.needsUpdate = true;
          mat.alphaMap.needsUpdate = true;
        }
      }

      function analyzeVibe() {
        const imgData = ctx.getImageData(0, 0, 512, 640).data;
        let r = 0,
          g = 0,
          b = 0,
          total = 0;
        for (let i = 0; i < imgData.length; i += 80) {
          if (
            imgData[i + 3] > 0 &&
            (imgData[i] < 245 || imgData[i + 1] < 245 || imgData[i + 2] < 245)
          ) {
            r += imgData[i];
            g += imgData[i + 1];
            b += imgData[i + 2];
            total++;
          }
        }
        if (total === 0) {
          updateUI("NEUTRAL", 0, "#38bdf8");
          return;
        }
        const avgR = r / total,
          avgB = b / total;
        let vibe = "NEUTRAL",
          intensity = 50,
          col = "#38bdf8";
        if (avgR > avgB + 30) {
          vibe = "INTENSE";
          col = "#ef4444";
          intensity = (avgR / 255) * 100;
        } else if (avgB > avgR + 30) {
          vibe = "MELANCHOLY";
          col = "#3b82f6";
          intensity = (avgB / 255) * 100;
        }
        updateUI(vibe, intensity, col);
      }

      function updateUI(t, p, c) {
        document.getElementById("vibeText").innerText = t;
        document.getElementById("vibeText").style.color = c;
        document.getElementById("vibeBar").style.width = p + "%";
        document.getElementById("vibeBar").style.background = c;
      }

      canvas.onmousedown = () => (isDrawing = true);
      window.onmouseup = () => {
        isDrawing = false;
        analyzeVibe();
      };
      canvas.onmousemove = (e) => {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (512 / rect.width);
        const y = (e.clientY - rect.top) * (640 / rect.height);
        ctx.save();
        ctx.globalCompositeOperation = "source-atop";
        ctx.fillStyle = document.getElementById("colorPicker").value;
        ctx.beginPath();
        ctx.arc(x, y, 15, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
        updateTexture();
      };

      function resetFace() {
        ctx.clearRect(0, 0, 512, 640);
        ctx.globalCompositeOperation = "source-over";
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, 512, 640);

        ctx.globalCompositeOperation = "destination-out";
        // WIDER EYES (Moved even further out)
        ctx.beginPath();
        ctx.ellipse(100, 280, 55, 35, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(412, 280, 55, 35, 0, 0, Math.PI * 2);
        ctx.fill();

        // MOUTH LOGIC
        if (currentExpression === "neutral") {
          // Narrow closed-lip slit
          ctx.beginPath();
          ctx.ellipse(256, 480, 60, 5, 0, 0, Math.PI * 2);
          ctx.fill();
        } else if (currentExpression === "happy") {
          // Crescent upward smile
          ctx.beginPath();
          ctx.arc(256, 450, 60, 0.1 * Math.PI, 0.9 * Math.PI, false);
          ctx.lineWidth = 15;
          ctx.lineCap = "round";
          ctx.stroke();
        } else if (currentExpression === "sad") {
          // Downward frown
          ctx.beginPath();
          ctx.arc(256, 530, 60, 1.1 * Math.PI, 1.9 * Math.PI, false);
          ctx.lineWidth = 15;
          ctx.lineCap = "round";
          ctx.stroke();
        }

        updateTexture();
        analyzeVibe();
      }

      let scene, camera, renderer, mat;
      function init() {
        scene = new THREE.Scene();
        const container = document.getElementById("viewer");
        camera = new THREE.PerspectiveCamera(
          35,
          container.clientWidth / container.clientHeight,
          0.1,
          1000,
        );
        camera.position.set(0, 0, 9);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);
        new THREE.OrbitControls(camera, renderer.domElement);

        const geo = new THREE.SphereGeometry(2.8, 220, 220, 0, Math.PI);
        const pos = geo.attributes.position;
        const uv = geo.attributes.uv;

        for (let i = 0; i < pos.count; i++) {
          let x = pos.getX(i),
            y = pos.getY(i),
            z = pos.getZ(i);
          pos.setX(i, x * 1.05);
          pos.setY(i, y * 1.4);
          uv.setXY(i, x / 2.8 + 0.5, y / 3.6 + 0.5);
          let nose = Math.exp(-(x * x * 25 + Math.pow(y - 0.1, 2) * 12));
          z += nose * 0.45;
          pos.setZ(i, z);
        }
        geo.computeVertexNormals();
        const canvasTex = new THREE.CanvasTexture(canvas);
        mat = new THREE.MeshStandardMaterial({
          map: canvasTex,
          alphaMap: canvasTex,
          transparent: true,
          alphaTest: 0.05,
          side: THREE.DoubleSide,
          roughness: 0.4,
        });
        scene.add(new THREE.Mesh(geo, mat));
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light = new THREE.DirectionalLight(0xffffff, 0.6);
        light.position.set(5, 5, 8);
        scene.add(light);
        resetFace();
        animate();
      }
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      init();
    </script>
  </body>
</html>
